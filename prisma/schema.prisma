generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  name          String?
  email         String?   @unique
  password      String?
  role          String
  businessName  String?
  companyName   String?
  collectorId   String?   @unique
  profileImage  String?
  address       String?
  contactNo     String?
  emailVerified Boolean   @default(false)
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())

  // ðŸ‘‡ self relation fix
  createdById  Int?
  createdBy    User?  @relation("creator", fields: [createdById], references: [id])
  createdUsers User[] @relation("creator")

  otps          Otp[]
  documents     UserDocument[]
  ocrDatas      OcrData[]
  refreshTokens RefreshToken[]
  activityLogs  ActivityLog[]  @relation("actorLogs")
}

model UserDocument {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  docType   String
  fileUrl   String
  fileName  String?
  createdAt DateTime @default(now())
}

model OcrData {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  docType   String
  ocrText   String
  fileUrl   String
  createdAt DateTime @default(now())
}

model Otp {
  id        Int      @id @default(autoincrement())
  userId    Int?     // Make optional for pending registrations
  email     String?  // Add email field for pending registrations
  otpHash   String
  purpose   String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  tokenHash String
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model ActivityLog {
  id           Int      @id @default(autoincrement())
  userId       Int?
  actorRole    String?
  action       String
  resourceType String?
  resourceId   String?
  meta         Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())
  actor        User?    @relation("actorLogs", fields: [userId], references: [id])
}

