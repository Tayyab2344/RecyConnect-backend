
> backend@1.0.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest tests/admin.test.js tests/item.test.js tests/kyc.test.js

(node:11964) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.error
    Error: User not found null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at approveKYC (src/controllers/adminController.js:36:23)

  console.error
    Error: Rejection reason is required null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at rejectKYC (src/controllers/adminController.js:82:25)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at src/middlewares/roleMiddleware.js:9:5
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at authenticateToken (src/middlewares/authMiddleware.js:18:5)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/admin.test.js (23.34 s)
  Admin Controller
    GET /api/admin/kyc/pending
      ‚àö should return 401 if not authenticated (1014 ms)
      √ó should return 403 if not admin (2618 ms)
      ‚àö should return pending KYC users for admin (3751 ms)
    POST /api/admin/kyc/approve
      ‚àö should approve a user KYC (2631 ms)
      ‚àö should return 404 for non-existent user (964 ms)
    POST /api/admin/kyc/reject
      ‚àö should reject a user KYC with reason (1803 ms)
      ‚àö should fail if reason is missing (748 ms)
    PUT /api/admin/users/:id/suspend
      ‚àö should suspend a user (1662 ms)
      ‚àö should activate a user (1665 ms)
    PUT /api/admin/rates
      √ó should update rates (490 ms)

  ‚óè Admin Controller ‚Ä∫ GET /api/admin/kyc/pending ‚Ä∫ should return 403 if not admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

    [0m [90m 49 |[39m                 [33m.[39m[36mget[39m([32m'/api/admin/kyc/pending'[39m)
     [90m 50 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${userToken}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 51 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 52 |[39m         })[33m;[39m
     [90m 53 |[39m
     [90m 54 |[39m         it([32m'should return pending KYC users for admin'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/admin.test.js:51:36)

  ‚óè Admin Controller ‚Ä∫ PUT /api/admin/rates ‚Ä∫ should update rates

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 161 |[39m                 })[33m;[39m
     [90m 162 |[39m
    [31m[1m>[22m[39m[90m 163 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 164 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mpricePerUnit)[33m.[39mtoBe([35m50.5[39m)[33m;[39m
     [90m 165 |[39m
     [90m 166 |[39m             [36mconst[39m rate [33m=[39m [36mawait[39m prisma[33m.[39mrate[33m.[39mfindUnique({ where[33m:[39m { category[33m:[39m [32m'PLASTIC'[39m } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:163:36)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Failed to create item { message: 'Invalid image file', name: 'Error', http_code: 400 }

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at createItem (src/controllers/itemController.js:42:9)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Item not found null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at getItem (src/controllers/itemController.js:78:27)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at deleteItem (src/controllers/itemController.js:95:20)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/item.test.js (21.18 s)
  Item Controller
    POST /api/items
      √ó should create a new item with images (4687 ms)
      ‚àö should fail without authentication (486 ms)
    GET /api/items
      ‚àö should list available items (3219 ms)
      ‚àö should filter items by category (1863 ms)
    GET /api/items/:id
      ‚àö should return item details (1532 ms)
      ‚àö should return 404 for unknown item (966 ms)
    DELETE /api/items/:id
      ‚àö should allow seller to delete their item (2115 ms)
      ‚àö should prevent unauthorized user from deleting item (946 ms)

  ‚óè Item Controller ‚Ä∫ POST /api/items ‚Ä∫ should create a new item with images

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 78 |[39m                 [33m.[39mattach([32m'images'[39m[33m,[39m [33mBuffer[39m[33m.[39m[36mfrom[39m([32m'fake image content'[39m)[33m,[39m [32m'test.jpg'[39m)[33m;[39m
     [90m 79 |[39m
    [31m[1m>[22m[39m[90m 80 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 81 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 82 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Scrap Metal'[39m)[33m;[39m
     [90m 83 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mimages)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:80:36)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Forbidden null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at src/middlewares/roleMiddleware.js:7:14
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at authenticateToken (src/middlewares/authMiddleware.js:18:5)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/kyc.test.js (10.713 s)
  KYC Controller
    POST /api/kyc/register
      √ó should reject individuals trying to do KYC (2112 ms)
      √ó should successfully verify company with valid docs (3 ms)
      √ó should auto-reject if CNIC extraction fails (4 ms)
    GET /api/kyc/status
      ‚àö should return KYC status (2351 ms)
      ‚àö should fail without auth (22 ms)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should reject individuals trying to do KYC

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

    [0m [90m 61 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${individualToken}`[39m)[33m;[39m
     [90m 62 |[39m
    [31m[1m>[22m[39m[90m 63 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 64 |[39m             expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/do not require KYC/[39m)[33m;[39m
     [90m 65 |[39m         })[33m;[39m
     [90m 66 |[39m[0m

      at Object.<anonymous> (tests/kyc.test.js:63:36)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should successfully verify company with valid docs

    TypeError: ocrService.extractTextFromUrl.mockResolvedValue is not a function

    [0m [90m 69 |[39m             [36mconst[39m ocrService [33m=[39m [36mawait[39m [36mimport[39m([32m'../src/services/ocrService.js'[39m)[33m;[39m
     [90m 70 |[39m
    [31m[1m>[22m[39m[90m 71 |[39m             ocrService[33m.[39mextractTextFromUrl[33m.[39mmockResolvedValue([32m'Valid CNIC: 12345-1234567-1 NTN: 1234567-8'[39m)[33m;[39m
     [90m    |[39m                                           [31m[1m^[22m[39m
     [90m 72 |[39m             ocrService[33m.[39mextractCNIC[33m.[39mmockReturnValue([32m'12345-1234567-1'[39m)[33m;[39m
     [90m 73 |[39m             ocrService[33m.[39mextractNTN[33m.[39mmockReturnValue([32m'1234567-8'[39m)[33m;[39m
     [90m 74 |[39m[0m

      at Object.<anonymous> (tests/kyc.test.js:71:43)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should auto-reject if CNIC extraction fails

    TypeError: ocrService.extractTextFromUrl.mockResolvedValue is not a function

    [0m [90m 90 |[39m             [36mconst[39m ocrService [33m=[39m [36mawait[39m [36mimport[39m([32m'../src/services/ocrService.js'[39m)[33m;[39m
     [90m 91 |[39m
    [31m[1m>[22m[39m[90m 92 |[39m             ocrService[33m.[39mextractTextFromUrl[33m.[39mmockResolvedValue([32m'No numbers here'[39m)[33m;[39m
     [90m    |[39m                                           [31m[1m^[22m[39m
     [90m 93 |[39m             ocrService[33m.[39mextractCNIC[33m.[39mmockReturnValue([36mnull[39m)[33m;[39m
     [90m 94 |[39m
     [90m 95 |[39m             [36mconst[39m res [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (tests/kyc.test.js:92:43)

Test Suites: 3 failed, 3 total
Tests:       6 failed, 17 passed, 23 total
Snapshots:   0 total
Time:        55.533 s
Ran all test suites matching tests/admin.test.js|tests/item.test.js|tests/kyc.test.js.
