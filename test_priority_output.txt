
> backend@1.0.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest tests/admin.test.js tests/item.test.js tests/kyc.test.js

(node:14420) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/admin.test.js (22.863 s)
  Admin Controller
    GET /api/admin/kyc/pending
      âˆš should return 401 if not authenticated (1033 ms)
      Ã— should return 403 if not admin (601 ms)
      Ã— should return pending KYC users for admin (525 ms)
    POST /api/admin/kyc/approve
      Ã— should approve a user KYC (1344 ms)
      Ã— should return 404 for non-existent user (537 ms)
    POST /api/admin/kyc/reject
      Ã— should reject a user KYC with reason (500 ms)
      Ã— should fail if reason is missing (713 ms)
    PUT /api/admin/users/:id/suspend
      Ã— should suspend a user (479 ms)
      Ã— should activate a user (962 ms)
    PUT /api/admin/rates
      Ã— should update rates (477 ms)

  â— Admin Controller â€º GET /api/admin/kyc/pending â€º should return 403 if not admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

    [0m [90m 49 |[39m                 [33m.[39m[36mget[39m([32m'/api/admin/kyc/pending'[39m)
     [90m 50 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${userToken}`[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 51 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 52 |[39m         })[33m;[39m
     [90m 53 |[39m
     [90m 54 |[39m         it([32m'should return pending KYC users for admin'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/admin.test.js:51:36)

  â— Admin Controller â€º GET /api/admin/kyc/pending â€º should return pending KYC users for admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 57 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${adminToken}`[39m)[33m;[39m
     [90m 58 |[39m
    [31m[1m>[22m[39m[90m 59 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 60 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 61 |[39m             expect([33mArray[39m[33m.[39misArray(res[33m.[39mbody[33m.[39mdata))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 62 |[39m             [90m// Check if our pending user is in the list[39m[0m

      at Object.<anonymous> (tests/admin.test.js:59:36)

  â— Admin Controller â€º POST /api/admin/kyc/approve â€º should approve a user KYC

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 73 |[39m                 [33m.[39msend({ userId[33m:[39m pendingUser[33m.[39mid })[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 76 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 77 |[39m
     [90m 78 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:75:36)

  â— Admin Controller â€º POST /api/admin/kyc/approve â€º should return 404 for non-existent user

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 87 |[39m                 [33m.[39msend({ userId[33m:[39m [35m999999[39m })[33m;[39m
     [90m 88 |[39m
    [31m[1m>[22m[39m[90m 89 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 90 |[39m         })[33m;[39m
     [90m 91 |[39m     })[33m;[39m
     [90m 92 |[39m[0m

      at Object.<anonymous> (tests/admin.test.js:89:36)

  â— Admin Controller â€º POST /api/admin/kyc/reject â€º should reject a user KYC with reason

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 101 |[39m                 })[33m;[39m
     [90m 102 |[39m
    [31m[1m>[22m[39m[90m 103 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 104 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 105 |[39m
     [90m 106 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:103:36)

  â— Admin Controller â€º POST /api/admin/kyc/reject â€º should fail if reason is missing

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 115 |[39m                 [33m.[39msend({ userId[33m:[39m pendingUser[33m.[39mid })[33m;[39m
     [90m 116 |[39m
    [31m[1m>[22m[39m[90m 117 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 118 |[39m         })[33m;[39m
     [90m 119 |[39m     })[33m;[39m
     [90m 120 |[39m[0m

      at Object.<anonymous> (tests/admin.test.js:117:36)

  â— Admin Controller â€º PUT /api/admin/users/:id/suspend â€º should suspend a user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 126 |[39m                 [33m.[39msend({ suspended[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 127 |[39m
    [31m[1m>[22m[39m[90m 128 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 129 |[39m
     [90m 130 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m
     [90m 131 |[39m             expect(updatedUser[33m.[39mverificationStatus)[33m.[39mtoBe([33mVerificationStatus[39m[33m.[39m[33mSUSPENDED[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:128:36)

  â— Admin Controller â€º PUT /api/admin/users/:id/suspend â€º should activate a user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 144 |[39m                 [33m.[39msend({ suspended[33m:[39m [36mfalse[39m })[33m;[39m
     [90m 145 |[39m
    [31m[1m>[22m[39m[90m 146 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 147 |[39m
     [90m 148 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m
     [90m 149 |[39m             expect(updatedUser[33m.[39mverificationStatus)[33m.[39mtoBe([33mVerificationStatus[39m[33m.[39m[33mVERIFIED[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:146:36)

  â— Admin Controller â€º PUT /api/admin/rates â€º should update rates

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 161 |[39m                 })[33m;[39m
     [90m 162 |[39m
    [31m[1m>[22m[39m[90m 163 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 164 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mpricePerUnit)[33m.[39mtoBe([35m50.5[39m)[33m;[39m
     [90m 165 |[39m
     [90m 166 |[39m             [36mconst[39m rate [33m=[39m [36mawait[39m prisma[33m.[39mrate[33m.[39mfindUnique({ where[33m:[39m { category[33m:[39m [32m'PLASTIC'[39m } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:163:36)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:63:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at param (node_modules/router/index.js:600:14)
      at param (node_modules/router/index.js:610:14)
      at processParams (node_modules/router/index.js:664:3)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/item.test.js (14.131 s)
  Item Controller
    POST /api/items
      Ã— should create a new item with images (1080 ms)
      âˆš should fail without authentication (510 ms)
    GET /api/items
      Ã— should list available items (546 ms)
      Ã— should filter items by category (959 ms)
    GET /api/items/:id
      Ã— should return item details (507 ms)
      Ã— should return 404 for unknown item (492 ms)
    DELETE /api/items/:id
      Ã— should allow seller to delete their item (494 ms)
      Ã— should prevent unauthorized user from deleting item (495 ms)

  â— Item Controller â€º POST /api/items â€º should create a new item with images

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 78 |[39m                 [33m.[39mattach([32m'images'[39m[33m,[39m [33mBuffer[39m[33m.[39m[36mfrom[39m([32m'fake image content'[39m)[33m,[39m [32m'test.jpg'[39m)[33m;[39m
     [90m 79 |[39m
    [31m[1m>[22m[39m[90m 80 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 81 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 82 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Scrap Metal'[39m)[33m;[39m
     [90m 83 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mimages)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:80:36)

  â— Item Controller â€º GET /api/items â€º should list available items

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m  99 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${buyerToken}`[39m)[33m;[39m
     [90m 100 |[39m
    [31m[1m>[22m[39m[90m 101 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 102 |[39m             expect([33mArray[39m[33m.[39misArray(res[33m.[39mbody[33m.[39mdata))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 103 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mlength)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m 104 |[39m             expect(res[33m.[39mbody[33m.[39mdata[[35m0[39m][33m.[39mtitle)[33m.[39mtoBe(testItem[33m.[39mtitle)[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:101:36)

  â— Item Controller â€º GET /api/items â€º should filter items by category

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 123 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${buyerToken}`[39m)[33m;[39m
     [90m 124 |[39m
    [31m[1m>[22m[39m[90m 125 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 126 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 127 |[39m             expect(res[33m.[39mbody[33m.[39mdata[[35m0[39m][33m.[39mcategory)[33m.[39mtoBe([32m'PAPER'[39m)[33m;[39m
     [90m 128 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:125:36)

  â— Item Controller â€º GET /api/items/:id â€º should return item details

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 135 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${buyerToken}`[39m)[33m;[39m
     [90m 136 |[39m
    [31m[1m>[22m[39m[90m 137 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 138 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mid)[33m.[39mtoBe(testItem[33m.[39mid)[33m;[39m
     [90m 139 |[39m         })[33m;[39m
     [90m 140 |[39m[0m

      at Object.<anonymous> (tests/item.test.js:137:36)

  â— Item Controller â€º GET /api/items/:id â€º should return 404 for unknown item

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 144 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${buyerToken}`[39m)[33m;[39m
     [90m 145 |[39m
    [31m[1m>[22m[39m[90m 146 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 147 |[39m         })[33m;[39m
     [90m 148 |[39m     })[33m;[39m
     [90m 149 |[39m[0m

      at Object.<anonymous> (tests/item.test.js:146:36)

  â— Item Controller â€º DELETE /api/items/:id â€º should allow seller to delete their item

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 154 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${sellerToken}`[39m)[33m;[39m
     [90m 155 |[39m
    [31m[1m>[22m[39m[90m 156 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 157 |[39m
     [90m 158 |[39m             [36mconst[39m check [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m testItem[33m.[39mid } })[33m;[39m
     [90m 159 |[39m             [90m// Should be marked as REMOVED or strictly deleted depending on implementation[39m[0m

      at Object.<anonymous> (tests/item.test.js:156:36)

  â— Item Controller â€º DELETE /api/items/:id â€º should prevent unauthorized user from deleting item

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

    [0m [90m 167 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${buyerToken}`[39m)[33m;[39m [90m// Buyer tries to delete seller's item[39m
     [90m 168 |[39m
    [31m[1m>[22m[39m[90m 169 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 170 |[39m         })[33m;[39m
     [90m 171 |[39m     })[33m;[39m
     [90m 172 |[39m })[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:169:36)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:63:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Unauthorized null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:20:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/kyc.test.js (5.882 s)
  KYC Controller
    POST /api/kyc/register
      Ã— should reject individuals trying to do KYC (99 ms)
      Ã— should successfully verify company with valid docs (7 ms)
      Ã— should auto-reject if CNIC extraction fails (5 ms)
    GET /api/kyc/status
      Ã— should return KYC status (91 ms)
      âˆš should fail without auth (161 ms)

  â— KYC Controller â€º POST /api/kyc/register â€º should reject individuals trying to do KYC

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 61 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${individualToken}`[39m)[33m;[39m
     [90m 62 |[39m
    [31m[1m>[22m[39m[90m 63 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 64 |[39m             expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoMatch([35m/do not require KYC/[39m)[33m;[39m
     [90m 65 |[39m         })[33m;[39m
     [90m 66 |[39m[0m

      at Object.<anonymous> (tests/kyc.test.js:63:36)

  â— KYC Controller â€º POST /api/kyc/register â€º should successfully verify company with valid docs

    TypeError: ocrService.extractTextFromUrl.mockResolvedValue is not a function

    [0m [90m 69 |[39m             [36mconst[39m ocrService [33m=[39m [36mawait[39m [36mimport[39m([32m'../src/services/ocrService.js'[39m)[33m;[39m
     [90m 70 |[39m
    [31m[1m>[22m[39m[90m 71 |[39m             ocrService[33m.[39mextractTextFromUrl[33m.[39mmockResolvedValue([32m'Valid CNIC: 12345-1234567-1 NTN: 1234567-8'[39m)[33m;[39m
     [90m    |[39m                                           [31m[1m^[22m[39m
     [90m 72 |[39m             ocrService[33m.[39mextractCNIC[33m.[39mmockReturnValue([32m'12345-1234567-1'[39m)[33m;[39m
     [90m 73 |[39m             ocrService[33m.[39mextractNTN[33m.[39mmockReturnValue([32m'1234567-8'[39m)[33m;[39m
     [90m 74 |[39m[0m

      at Object.<anonymous> (tests/kyc.test.js:71:43)

  â— KYC Controller â€º POST /api/kyc/register â€º should auto-reject if CNIC extraction fails

    TypeError: ocrService.extractTextFromUrl.mockResolvedValue is not a function

    [0m [90m 90 |[39m             [36mconst[39m ocrService [33m=[39m [36mawait[39m [36mimport[39m([32m'../src/services/ocrService.js'[39m)[33m;[39m
     [90m 91 |[39m
    [31m[1m>[22m[39m[90m 92 |[39m             ocrService[33m.[39mextractTextFromUrl[33m.[39mmockResolvedValue([32m'No numbers here'[39m)[33m;[39m
     [90m    |[39m                                           [31m[1m^[22m[39m
     [90m 93 |[39m             ocrService[33m.[39mextractCNIC[33m.[39mmockReturnValue([36mnull[39m)[33m;[39m
     [90m 94 |[39m
     [90m 95 |[39m             [36mconst[39m res [33m=[39m [36mawait[39m request(app)[0m

      at Object.<anonymous> (tests/kyc.test.js:92:43)

  â— KYC Controller â€º GET /api/kyc/status â€º should return KYC status

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 114 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${companyToken}`[39m)[33m;[39m
     [90m 115 |[39m
    [31m[1m>[22m[39m[90m 116 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 117 |[39m             expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveProperty([32m'kycStatus'[39m)[33m;[39m
     [90m 118 |[39m             expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveProperty([32m'rejectionReason'[39m)[33m;[39m
     [90m 119 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/kyc.test.js:116:36)

Test Suites: 3 failed, 3 total
Tests:       20 failed, 3 passed, 23 total
Snapshots:   0 total
Time:        43.362 s
Ran all test suites matching tests/admin.test.js|tests/item.test.js|tests/kyc.test.js.
