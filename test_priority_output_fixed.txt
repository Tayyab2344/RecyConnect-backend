
> backend@1.0.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest tests/admin.test.js tests/item.test.js tests/kyc.test.js

(node:13272) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Missing auth token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:11:14)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:54:5)
      at jsonParser (node_modules/body-parser/lib/types/json.js:90:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Function.handle (node_modules/router/index.js:186:3)
      at Function.handle (node_modules/express/lib/application.js:177:15)
      at Server.app (node_modules/express/lib/express.js:38:9)

  console.error
    Error: Forbidden null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at src/middlewares/roleMiddleware.js:7:14
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at authenticateToken (src/middlewares/authMiddleware.js:18:5)

  console.error
    Error: Failed to approve KYC PrismaClientKnownRequestError: 
    Invalid `prisma.user.update()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\src\controllers\adminController.js:50:23
    
      47   updateData.requestedRole = null; // Clear request
      48 }
      49 
    ‚Üí 50 await prisma.user.update(
    An operation failed because it depends on one or more records that were required but not found. No record was found for an update.
        at ei.handleRequestError (C:\Users\tayya\Desktop\RecyConnect-backend\node_modules\@prisma\client\src\runtime\RequestHandler.ts:228:13)
        at ei.handleAndLogRequestError (C:\Users\tayya\Desktop\RecyConnect-backend\node_modules\@prisma\client\src\runtime\RequestHandler.ts:174:12)
        at ei.request (C:\Users\tayya\Desktop\RecyConnect-backend\node_modules\@prisma\client\src\runtime\RequestHandler.ts:143:12)
        at a (C:\Users\tayya\Desktop\RecyConnect-backend\node_modules\@prisma\client\src\runtime\getPrismaClient.ts:833:24)
        at approveKYC (C:\Users\tayya\Desktop\RecyConnect-backend\src\controllers\adminController.js:50:5) {
      code: 'P2025',
      meta: { modelName: 'User', cause: 'No record was found for an update.' },
      clientVersion: '6.19.0'
    }

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at approveKYC (src/controllers/adminController.js:73:5)

  console.error
    Error: User not found null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at approveKYC (src/controllers/adminController.js:36:23)

  console.error
    Error: User not found null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at rejectKYC (src/controllers/adminController.js:85:23)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/admin.test.js (27.429 s)
  Admin Controller
    GET /api/admin/kyc/pending
      ‚àö should return 401 if not authenticated (1018 ms)
      ‚àö should return 403 if not admin (3064 ms)
      ‚àö should return pending KYC users for admin (4095 ms)
    POST /api/admin/kyc/approve
      √ó should approve a user KYC (2947 ms)
      ‚àö should return 404 for non-existent user (1257 ms)
    POST /api/admin/kyc/reject
      √ó should reject a user KYC with reason (1531 ms)
      √ó should fail if reason is missing (996 ms)
    PUT /api/admin/users/:id/suspend
      √ó should suspend a user (819 ms)
      √ó should activate a user (1701 ms)
    PUT /api/admin/rates
      √ó should update rates (736 ms)

  ‚óè Admin Controller ‚Ä∫ POST /api/admin/kyc/approve ‚Ä∫ should approve a user KYC

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 79 |[39m                 [33m.[39msend({ userId[33m:[39m pendingUser[33m.[39mid })[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 82 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 83 |[39m
     [90m 84 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:81:36)

  ‚óè Admin Controller ‚Ä∫ POST /api/admin/kyc/reject ‚Ä∫ should reject a user KYC with reason

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 107 |[39m                 })[33m;[39m
     [90m 108 |[39m
    [31m[1m>[22m[39m[90m 109 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 110 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 111 |[39m
     [90m 112 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:109:36)

  ‚óè Admin Controller ‚Ä∫ POST /api/admin/kyc/reject ‚Ä∫ should fail if reason is missing

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 121 |[39m                 [33m.[39msend({ userId[33m:[39m pendingUser[33m.[39mid })[33m;[39m
     [90m 122 |[39m
    [31m[1m>[22m[39m[90m 123 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 124 |[39m         })[33m;[39m
     [90m 125 |[39m     })[33m;[39m
     [90m 126 |[39m[0m

      at Object.<anonymous> (tests/admin.test.js:123:36)

  ‚óè Admin Controller ‚Ä∫ PUT /api/admin/users/:id/suspend ‚Ä∫ should suspend a user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 132 |[39m                 [33m.[39msend({ suspended[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 133 |[39m
    [31m[1m>[22m[39m[90m 134 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 135 |[39m
     [90m 136 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m
     [90m 137 |[39m             expect(updatedUser[33m.[39mverificationStatus)[33m.[39mtoBe([33mVerificationStatus[39m[33m.[39m[33mSUSPENDED[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:134:36)

  ‚óè Admin Controller ‚Ä∫ PUT /api/admin/users/:id/suspend ‚Ä∫ should activate a user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 150 |[39m                 [33m.[39msend({ suspended[33m:[39m [36mfalse[39m })[33m;[39m
     [90m 151 |[39m
    [31m[1m>[22m[39m[90m 152 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 153 |[39m
     [90m 154 |[39m             [36mconst[39m updatedUser [33m=[39m [36mawait[39m prisma[33m.[39muser[33m.[39mfindUnique({ where[33m:[39m { id[33m:[39m pendingUser[33m.[39mid } })[33m;[39m
     [90m 155 |[39m             expect(updatedUser[33m.[39mverificationStatus)[33m.[39mtoBe([33mVerificationStatus[39m[33m.[39m[33mVERIFIED[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:152:36)

  ‚óè Admin Controller ‚Ä∫ PUT /api/admin/rates ‚Ä∫ should update rates

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 167 |[39m                 })[33m;[39m
     [90m 168 |[39m
    [31m[1m>[22m[39m[90m 169 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 170 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mpricePerUnit)[33m.[39mtoBe([35m50.5[39m)[33m;[39m
     [90m 171 |[39m
     [90m 172 |[39m             [36mconst[39m rate [33m=[39m [36mawait[39m prisma[33m.[39mrate[33m.[39mfindUnique({ where[33m:[39m { category[33m:[39m [32m'PLASTIC'[39m } })[33m;[39m[0m

      at Object.<anonymous> (tests/admin.test.js:169:36)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.error
    Error: Invalid token null

    [0m [90m 48 |[39m [90m */[39m
     [90m 49 |[39m [36mexport[39m [36mconst[39m sendError [33m=[39m (res[33m,[39m message[33m,[39m error [33m=[39m [36mnull[39m[33m,[39m statusCode [33m=[39m [35m500[39m) [33m=>[39m {
    [31m[1m>[22m[39m[90m 50 |[39m     console[33m.[39merror([32m`Error: ${message}`[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 51 |[39m
     [90m 52 |[39m     [36mconst[39m response [33m=[39m {
     [90m 53 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m[0m

      at sendError (src/utils/responseHelper.js:50:13)
      at authenticateToken (src/middlewares/authMiddleware.js:16:23)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/item.test.js (12.1 s)
  Item Controller
    POST /api/items
      √ó should create a new item with images (3103 ms)
      √ó should fail without authentication (748 ms)
    GET /api/items
      √ó should list available items (506 ms)
      √ó should filter items by category (460 ms)
    GET /api/items/:id
      √ó should return item details (530 ms)
      √ó should return 404 for unknown item (468 ms)
    DELETE /api/items/:id
      √ó should allow seller to delete their item (469 ms)
      √ó should prevent unauthorized user from deleting item (516 ms)

  ‚óè Item Controller ‚Ä∫ POST /api/items ‚Ä∫ should create a new item with images

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 82 |[39m                 [33m.[39mattach([32m'images'[39m[33m,[39m [33mBuffer[39m[33m.[39m[36mfrom[39m([32m'fake image content'[39m)[33m,[39m [32m'test.jpg'[39m)[33m;[39m
     [90m 83 |[39m
    [31m[1m>[22m[39m[90m 84 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 85 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 86 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Scrap Metal'[39m)[33m;[39m
     [90m 87 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mimages)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/item.test.js:84:36)

  ‚óè Item Controller ‚Ä∫ POST /api/items ‚Ä∫ should fail without authentication

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ GET /api/items ‚Ä∫ should list available items

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ GET /api/items ‚Ä∫ should filter items by category

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ GET /api/items/:id ‚Ä∫ should return item details

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ GET /api/items/:id ‚Ä∫ should return 404 for unknown item

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ DELETE /api/items/:id ‚Ä∫ should allow seller to delete their item

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  ‚óè Item Controller ‚Ä∫ DELETE /api/items/:id ‚Ä∫ should prevent unauthorized user from deleting item

    PrismaClientKnownRequestError: 
    Invalid `prisma.item.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\item.test.js:44:38

      41 
      42 beforeEach(async () => {
      43     // Create a test item before each test interaction if needed, or just once
    ‚Üí 44     testItem = await prisma.item.create(
    Foreign key constraint violated on the constraint: `Item_sellerId_fkey`

    [0m [90m 42 |[39m     beforeEach([36masync[39m () [33m=>[39m {
     [90m 43 |[39m         [90m// Create a test item before each test interaction if needed, or just once[39m
    [31m[1m>[22m[39m[90m 44 |[39m         testItem [33m=[39m [36mawait[39m prisma[33m.[39mitem[33m.[39mcreate({
     [90m    |[39m                    [31m[1m^[22m[39m
     [90m 45 |[39m             data[33m:[39m {
     [90m 46 |[39m                 sellerId[33m:[39m seller[33m.[39mid[33m,[39m
     [90m 47 |[39m                 title[33m:[39m [32m'Test Plastic Bottles'[39m[33m,[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/item.test.js:44:20)

  console.log
    Test database connected

      at Object.<anonymous> (tests/setup.js:17:13)

  console.log
    Test database disconnected

      at Object.<anonymous> (tests/setup.js:28:13)

FAIL tests/kyc.test.js (6.386 s)
  KYC Controller
    POST /api/kyc/register
      √ó should reject individuals trying to do KYC (3 ms)
      √ó should successfully verify company with valid docs (3 ms)
      √ó should auto-reject if CNIC extraction fails (4 ms)
    GET /api/kyc/status
      √ó should return KYC status (2 ms)
      √ó should fail without auth (1 ms)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should reject individuals trying to do KYC

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\helpers.js:46:24

      43     ...data
      44 };
      45 
    ‚Üí 46 return prisma.user.create(
    Unique constraint failed on the fields: (`email`)

    [0m [90m 43 |[39m
     [90m 44 |[39m     beforeAll([36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         companyUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'company@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mCOMPANY[39m })[33m;[39m
     [90m    |[39m                       [31m[1m^[22m[39m
     [90m 46 |[39m         companyToken [33m=[39m generateTestToken(companyUser)[33m;[39m
     [90m 47 |[39m
     [90m 48 |[39m         individualUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'indiv@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mINDIVIDUAL[39m })[33m;[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/kyc.test.js:45:23)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should successfully verify company with valid docs

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\helpers.js:46:24

      43     ...data
      44 };
      45 
    ‚Üí 46 return prisma.user.create(
    Unique constraint failed on the fields: (`email`)

    [0m [90m 43 |[39m
     [90m 44 |[39m     beforeAll([36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         companyUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'company@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mCOMPANY[39m })[33m;[39m
     [90m    |[39m                       [31m[1m^[22m[39m
     [90m 46 |[39m         companyToken [33m=[39m generateTestToken(companyUser)[33m;[39m
     [90m 47 |[39m
     [90m 48 |[39m         individualUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'indiv@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mINDIVIDUAL[39m })[33m;[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/kyc.test.js:45:23)

  ‚óè KYC Controller ‚Ä∫ POST /api/kyc/register ‚Ä∫ should auto-reject if CNIC extraction fails

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\helpers.js:46:24

      43     ...data
      44 };
      45 
    ‚Üí 46 return prisma.user.create(
    Unique constraint failed on the fields: (`email`)

    [0m [90m 43 |[39m
     [90m 44 |[39m     beforeAll([36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         companyUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'company@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mCOMPANY[39m })[33m;[39m
     [90m    |[39m                       [31m[1m^[22m[39m
     [90m 46 |[39m         companyToken [33m=[39m generateTestToken(companyUser)[33m;[39m
     [90m 47 |[39m
     [90m 48 |[39m         individualUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'indiv@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mINDIVIDUAL[39m })[33m;[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/kyc.test.js:45:23)

  ‚óè KYC Controller ‚Ä∫ GET /api/kyc/status ‚Ä∫ should return KYC status

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\helpers.js:46:24

      43     ...data
      44 };
      45 
    ‚Üí 46 return prisma.user.create(
    Unique constraint failed on the fields: (`email`)

    [0m [90m 43 |[39m
     [90m 44 |[39m     beforeAll([36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         companyUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'company@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mCOMPANY[39m })[33m;[39m
     [90m    |[39m                       [31m[1m^[22m[39m
     [90m 46 |[39m         companyToken [33m=[39m generateTestToken(companyUser)[33m;[39m
     [90m 47 |[39m
     [90m 48 |[39m         individualUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'indiv@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mINDIVIDUAL[39m })[33m;[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/kyc.test.js:45:23)

  ‚óè KYC Controller ‚Ä∫ GET /api/kyc/status ‚Ä∫ should fail without auth

    PrismaClientKnownRequestError: 
    Invalid `prisma.user.create()` invocation in
    C:\Users\tayya\Desktop\RecyConnect-backend\tests\helpers.js:46:24

      43     ...data
      44 };
      45 
    ‚Üí 46 return prisma.user.create(
    Unique constraint failed on the fields: (`email`)

    [0m [90m 43 |[39m
     [90m 44 |[39m     beforeAll([36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         companyUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'company@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mCOMPANY[39m })[33m;[39m
     [90m    |[39m                       [31m[1m^[22m[39m
     [90m 46 |[39m         companyToken [33m=[39m generateTestToken(companyUser)[33m;[39m
     [90m 47 |[39m
     [90m 48 |[39m         individualUser [33m=[39m [36mawait[39m createTestUser({ email[33m:[39m [32m'indiv@test.com'[39m[33m,[39m role[33m:[39m [33mUserRole[39m[33m.[39m[33mINDIVIDUAL[39m })[33m;[39m[0m

      at ei.handleRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:228:13)
      at ei.handleAndLogRequestError (node_modules/@prisma/client/src/runtime/RequestHandler.ts:174:12)
      at ei.request (node_modules/@prisma/client/src/runtime/RequestHandler.ts:143:12)
      at a (node_modules/@prisma/client/src/runtime/getPrismaClient.ts:833:24)
      at Object.<anonymous> (tests/kyc.test.js:45:23)

Test Suites: 3 failed, 3 total
Tests:       19 failed, 4 passed, 23 total
Snapshots:   0 total
Time:        46.184 s
Ran all test suites matching tests/admin.test.js|tests/item.test.js|tests/kyc.test.js.
